#!/usr/bin/env bash

FILE_PATH="${1}"
WIDTH="${2}"
HEIGHT="${3}"
X="${4}"
Y="${5}"
TERM_PROGRAM="${TERM}"

# Asegúrate de que .cache/lf exista
CACHE_DIR="${HOME}/.cache/lf"
mkdir -p "$CACHE_DIR"

# Utilidad para hash de caché
hash() {
  printf '%s/%s.jpg' "$CACHE_DIR" "$(stat --printf '%n\0%i\0%F\0%s\0%W\0%Y' "$1" | md5sum | awk '{print $1}')"
}

IMAGE_CACHE_PATH="$(hash "$FILE_PATH")"

# Detecta si es imagen
is_image() {
  file --mime-type --brief "$1" | grep -q '^image/'
}

# Usa kitty +kitten icat si disponible
preview_with_kitty() {
  if ! command -v kitty &>/dev/null; then return 1; fi
  if [ -z "$KITTY_WINDOW_ID" ]; then return 1; fi

  kitty +kitten icat --transfer-mode memory --stdin no \
    --place "${WIDTH}x${HEIGHT}@${X}x${Y}" "$1" </dev/null >/dev/tty
  return 0
}

# Si no es imagen o fallan previews gráficos
preview_fallback
